name: Performance Tests

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Setup Environment
      run: |
        sudo modprobe cpufreq_performance
        sudo cpupower frequency-set -g performance  || \
        echo 'performance' | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor || \
        echo "CPU frequency control not available, running with default settings"
        sudo systemctl stop bluetooth cups avahi-daemon 
    - name: Verify CPU Settings  
      run: |  
        if [ -f /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor ]; then  
          echo "Current governor: $(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor)"  
        fi  
        cat /proc/cpuinfo | grep "processor" | head -5 
    - name: Configure CMake
      run: |
        cmake -B ${{ github.workspace }}/build
        -DCMAKE_BUILD_TYPE=Release
        -DOPT_SYSTEM_MALLOC=OFF
        -DOPT_PERFTEST=ON
        -DOPT_FAST_COPY=OFF
        -DOPT_INTERNAL_FREETYPE=ON
        -DOPT_DEMOS=OFF
        -DOPT_TESTS=OFF
        -S ${{ github.workspace }}      
    - name: Build
      run: cmake --build ${{ github.workspace }}/build --config Release 
    - name: Test
      run: ${{ github.workspace }}/build/perf_tests
    - name: Upload Test Reaults
      if: always()
      uses: actions/upload-artifact@v4.6.2
      with:
        name: test-perf_benchmark-linux
        path: |
          ${{ github.workspace }}/build/benchmark/
